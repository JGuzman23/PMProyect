<!-- Notification Toast -->
<div
  *ngIf="notification"
  [class.bg-green-500]="notification.type === 'success'"
  [class.bg-red-500]="notification.type === 'error'"
  [class.bg-blue-500]="notification.type === 'info'"
  class="fixed top-4 right-4 z-[100] px-6 py-4 rounded-lg shadow-lg text-white flex items-center gap-3 animate-slide-in"
  style="animation: slideIn 0.3s ease-out;"
>
  <svg *ngIf="notification.type === 'success'" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
  </svg>
  <svg *ngIf="notification.type === 'error'" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
  </svg>
  <svg *ngIf="notification.type === 'info'" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
  </svg>
  <span class="font-medium">{{ notification.message }}</span>
  <button
    (click)="closeNotification()"
    class="ml-4 text-white hover:text-gray-200"
  >
    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
    </svg>
  </button>
</div>

<div class="h-screen flex flex-col overflow-hidden">
  <div class="flex-shrink-0 px-1 sm:px-2 md:px-4 pt-2 pb-3 sm:pb-4 bg-gray-50 z-10">
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-4 mb-2 sm:mb-4">
      <!-- Board Title and Description -->
      <div class="flex-1 min-w-0">
        <!-- Modo edición -->
        <div *ngIf="isEditingBoard" class="space-y-2">
          <input
            type="text"
            [(ngModel)]="boardForm.name"
            [placeholder]="'boards.name' | translate"
            class="w-full text-base sm:text-lg md:text-xl lg:text-2xl font-bold text-gray-900 border-2 border-indigo-500 rounded-md px-2 py-1 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          />
          <textarea
            [(ngModel)]="boardForm.description"
            [placeholder]="'boards.description' | translate"
            rows="2"
            class="w-full text-xs sm:text-sm md:text-base text-gray-600 border-2 border-indigo-500 rounded-md px-2 py-1 focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none"
          ></textarea>
          <div class="flex items-center gap-2">
            <button
              type="button"
              (click)="saveBoard()"
              class="px-3 py-1.5 bg-indigo-600 text-white text-xs sm:text-sm rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            >
              {{ 'common.save' | translate }}
            </button>
            <button
              type="button"
              (click)="cancelBoardEdit()"
              class="px-3 py-1.5 bg-gray-300 text-gray-700 text-xs sm:text-sm rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500"
            >
              {{ 'common.cancel' | translate }}
            </button>
          </div>
        </div>
        <!-- Modo visualización -->
        <div *ngIf="!isEditingBoard">
          <div class="flex items-start gap-2">
            <h2 class="text-base sm:text-lg md:text-xl lg:text-2xl font-bold text-gray-900 mb-1 sm:mb-2 flex-1">{{ board?.name }}</h2>
            <button
              type="button"
              (click)="enableBoardEdit()"
              class="p-1.5 text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-md transition-colors"
              [title]="'boards.editBoard' | translate"
            >
              <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
              </svg>
            </button>
          </div>
          <p class="text-xs sm:text-sm md:text-base text-gray-600">{{ board?.description || ('boards.noDescription' | translate) }}</p>
        </div>
      </div>

      <!-- Filter Options -->
      <div class="flex items-center gap-2 flex-wrap w-full sm:w-auto flex-shrink-0">
        <!-- Filter by Client -->
        <div *ngIf="clients.length > 0" class="relative inline-block">
          <app-combobox
            [label]="''"
            [placeholder]="('tasks.client' | translate) || 'Cliente'"
            [items]="clients"
            [display]="displayClient"
            [searchable]="true"
            [multiple]="true"
            [required]="false"
            [value]="getSelectedFilterClients()"
            (selectionChange)="onFilterClientSelected($event)">
          </app-combobox>
          <span *ngIf="hasFilterClients()" class="absolute -top-1 -right-1 inline-flex items-center justify-center px-1.5 py-0.5 text-xs font-bold leading-none text-indigo-600 bg-indigo-100 rounded-full z-10">
              {{ getFilterClientCount() }}
            </span>
        </div>

        <!-- Filter by Assignee -->
        <div *ngIf="users.length > 0" class="relative inline-block">
          <app-combobox
            [label]="''"
            [placeholder]="('tasks.assignedTo' | translate) || 'Asignado a'"
            [items]="users"
            [display]="displayUser"
            [searchable]="true"
            [multiple]="true"
            [required]="false"
            [value]="getSelectedFilterUsers()"
            (selectionChange)="onFilterAssigneeSelected($event)">
          </app-combobox>
          <span *ngIf="hasFilterAssignees()" class="absolute -top-1 -right-1 inline-flex items-center justify-center px-1.5 py-0.5 text-xs font-bold leading-none text-indigo-600 bg-indigo-100 rounded-full z-10">
              {{ getFilterAssigneeCount() }}
            </span>
        </div>

        <!-- Filter by Status -->
        <div *ngIf="columns.length > 0" class="relative inline-block">
          <app-combobox
            [label]="''"
            [placeholder]="('admin.statusName' | translate) || 'Estado'"
            [items]="columns"
            [display]="displayColumn"
            [searchable]="true"
            [multiple]="true"
            [required]="false"
            [value]="getSelectedFilterColumns()"
            (selectionChange)="onFilterStatusSelected($event)">
          </app-combobox>
          <span *ngIf="hasFilterStatuses()" class="absolute -top-1 -right-1 inline-flex items-center justify-center px-1.5 py-0.5 text-xs font-bold leading-none text-indigo-600 bg-indigo-100 rounded-full z-10">
              {{ getFilterStatusCount() }}
            </span>
        </div>

        <!-- Filter by Priority -->
        <div class="relative inline-block">
          <app-combobox
            [label]="''"
            [placeholder]="('tasks.priority' | translate) || 'Prioridad'"
            [items]="getPriorities()"
            [display]="displayPriority"
            [searchable]="true"
            [multiple]="true"
            [required]="false"
            [value]="getSelectedFilterPriorities()"
            [compareFn]="comparePriorities"
            (selectionChange)="onFilterPrioritySelected($event)">
          </app-combobox>
          <span *ngIf="hasFilterPriorities()" class="absolute -top-1 -right-1 inline-flex items-center justify-center px-1.5 py-0.5 text-xs font-bold leading-none text-indigo-600 bg-indigo-100 rounded-full z-10">
              {{ getFilterPriorityCount() }}
            </span>
        </div>

        <!-- Clear Filters Button -->
        <button
          *ngIf="hasActiveFilters()"
          type="button"
          (click)="clearFilters()"
          class="inline-flex items-center px-3 py-1.5 text-xs sm:text-sm border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500"
        >
          <svg class="w-4 h-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
          {{ 'common.clear' | translate }}
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="loading" class="flex-1 flex items-center justify-center">
    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
  </div>

  <div *ngIf="!loading && !board" class="flex-1 flex items-center justify-center">
    <p class="text-gray-500">{{ 'boards.couldNotLoadBoard' | translate }}</p>
  </div>

  <div *ngIf="!loading && board && columns.length === 0" class="flex-1 flex flex-col items-center justify-center">
    <p class="text-gray-500 mb-4">{{ 'boards.noColumnsInBoard' | translate }}</p>
    <button
      (click)="openStatusCreateModal()"
      class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700"
    >
      <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      {{ 'admin.createStatus' | translate }}
    </button>
  </div>

  <div 
    *ngIf="!loading && board && columns.length > 0" 
    #boardScrollContainer
    class="overflow-x-auto overflow-y-auto max-h-[calc(100vh-180px)] cursor-grab active:cursor-grabbing" 
    cdkDropListGroup 
    style="height: calc(100vh - 180px);"
    (mousedown)="onBoardMouseDown($event)"
    (mousemove)="onBoardMouseMove($event)"
    (mouseup)="onBoardMouseUp()"
    (mouseleave)="onBoardMouseLeave()"
  >
    <div class="flex gap-2 sm:gap-3 md:gap-4 px-1 sm:px-2 md:px-4 pb-4 min-w-max">
    <div
      *ngFor="let column of columns; let i = index"
      cdkDropList
      [id]="'column-' + i"
      [cdkDropListData]="column.tasks"
      (cdkDropListDropped)="drop($event, i)"
      class="flex-shrink-0 w-[280px] sm:w-62 md:w-70 rounded-lg p-2 sm:p-3 md:p-4"
      [style.background-color]="column.color ? (column.color + '15') : '#F3F4F6'"
    >
      <div class="flex items-center justify-between mb-3 sm:mb-4">
        <div class="flex items-center space-x-2">
          <div
            *ngIf="column.color"
            class="w-3 h-3 rounded-full flex-shrink-0"
            [style.background-color]="column.color"
          ></div>
          <h3 class="text-sm sm:text-base font-semibold text-gray-900">{{ column.name }}</h3>
        </div>
        <div class="flex items-center space-x-2">
          <button
            (click)="openCreateTaskModal(i); $event.stopPropagation()"
            class="p-1 text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 rounded transition-colors"
            [title]="'tasks.addTask' | translate"
          >
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
          </button>
          <button
            (click)="openStatusEditModal(column); $event.stopPropagation()"
            class="p-1 text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 rounded transition-colors"
            [title]="'admin.editStatus' | translate"
          >
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
          </button>
          <span class="text-xs sm:text-sm text-gray-500">{{ column.tasks.length }}</span>
        </div>
      </div>

      <div class="space-y-2 sm:space-y-3">
        <div
          *ngFor="let task of column.tasks"
          cdkDrag
          (cdkDragStarted)="onDragStarted()"
          (cdkDragEnded)="onDragEnded()"
          (click)="!isDragging && openTaskModal(task)"
          class="bg-white rounded-lg shadow p-2.5 sm:p-3 md:p-4 cursor-grab active:cursor-grabbing hover:shadow-md transition-shadow"
        >
           <div class="flex items-start justify-between mb-2">
             <div class="flex-1 pr-2 min-w-0">
               <h4 class="text-sm sm:text-base font-medium text-gray-900 flex-1 min-w-0 break-words mb-1">{{ task.title }}</h4>
             </div>
             <div class="flex flex-col items-end gap-1 flex-shrink-0">
               <span
                 [class]="getPriorityClass(task.priority)"
                 class="px-1.5 sm:px-2 py-0.5 sm:py-1 rounded text-xs font-medium"
               >
                 {{ task.priority }}
               </span>
               <span *ngIf="task.taskId" class="text-[10px] sm:text-xs font-mono font-semibold text-indigo-600 bg-indigo-50 px-1.5 py-0.5 rounded">
                 {{ task.taskId }}
               </span>
             </div>
           </div>
          <!-- Cliente o Agente -->
          <div *ngIf="task.clientId" class="mb-2">
            <div class="flex items-center gap-1.5">
              <svg class="w-3 h-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
              <!-- Si es empresa, mostrar solo el agente -->
              <span *ngIf="getTaskClientType(task) === 'empresa' && getTaskAgentName(task)" class="text-xs text-gray-600 font-medium">
                {{ getTaskAgentName(task) }}
              </span>
              <!-- Si es persona, mostrar el cliente -->
              <span *ngIf="getTaskClientType(task) === 'persona' && getTaskClientName(task)" class="text-xs text-gray-600 font-medium">
                {{ getTaskClientName(task) }}
              </span>
            </div>
          </div>
          <!-- Etiquetas -->
          <div *ngIf="task.labels && task.labels.length > 0" class="flex flex-wrap gap-1 mb-2">
            <span
              *ngFor="let label of task.labels"
              class="px-2 py-0.5 rounded text-xs font-medium"
              [style.background-color]="label.color + '20'"
              [style.color]="label.color"
              [style.border-color]="label.color"
              style="border: 1px solid;"
            >
              {{ label.name }}
            </span>
          </div>
          <div *ngIf="task.description" class="text-xs sm:text-sm text-gray-600 mb-2 line-clamp-2 prose prose-sm max-w-none" [innerHTML]="task.description"></div>
          <div class="flex items-center justify-between mt-2">
            <div class="flex -space-x-1.5 sm:-space-x-2">
              <div
                *ngFor="let assignee of task.assignees"
                class="h-5 w-5 sm:h-6 sm:w-6 rounded-full bg-indigo-600 text-white text-xs flex items-center justify-center"
                [title]="assignee.firstName + ' ' + assignee.lastName"
              >
                {{ assignee.firstName[0] }}{{ assignee.lastName[0] }}
              </div>
            </div>
            <span *ngIf="task.dueDate" class="text-xs text-gray-500">
              {{ task.dueDate | date: 'short' }}
            </span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Add New Status Button -->
    <div class="flex-shrink-0 w-[280px] sm:w-62 md:w-70">
      <button
        (click)="openStatusCreateModal()"
        class="w-full h-full min-h-[200px] rounded-lg border-2 border-dashed border-gray-300 hover:border-indigo-500 hover:bg-indigo-50 transition-colors flex flex-col items-center justify-center p-4"
      >
        <svg class="w-8 h-8 text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        <span class="text-sm font-medium text-gray-600">{{ 'admin.createStatus' | translate }}</span>
      </button>
    </div>
    </div>
  </div>

  <!-- Task Modal -->
  <app-task-modal
    *ngIf="showTaskModal"
    [task]="selectedTask"
    [columns]="columns"
    [users]="users"
    [clients]="clients"
    [isOpen]="showTaskModal"
    (close)="closeTaskModal()"
    (save)="onTaskModalSave($event)"
    (delete)="onTaskModalDelete($event)"
    (taskUpdated)="onTaskUpdated($event)"
  ></app-task-modal>

  <!-- Status Edit Modal -->
  <div
    *ngIf="showStatusModal"
    class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4"
    (click)="closeStatusModal()"
  >
    <div class="relative mx-auto p-4 sm:p-5 border w-full max-w-md sm:w-96 shadow-lg rounded-md bg-white my-auto" (click)="$event.stopPropagation()">
      <h3 class="text-lg font-bold text-gray-900 mb-4">
        {{ selectedStatus ? ('admin.editStatus' | translate) : ('admin.createStatus' | translate) }}
      </h3>
      <form (ngSubmit)="saveStatus()">
        <div *ngIf="statusError" class="mb-4 p-3 bg-red-50 border border-red-200 rounded-md text-red-700 text-sm">
          {{ statusError }}
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'admin.statusName' | translate }} <span class="text-red-500">*</span></label>
          <input
            type="text"
            [(ngModel)]="statusForm.name"
            name="statusName"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
          />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">{{ 'admin.statusColor' | translate }}</label>
          <input
            type="color"
            [(ngModel)]="statusForm.color"
            name="statusColor"
            required
            class="w-full h-10 border border-gray-300 rounded-md"
          />
        </div>
        <div class="flex flex-col sm:flex-row justify-end gap-2 sm:space-x-3 sm:gap-0">
          <button
            type="button"
            (click)="closeStatusModal()"
            class="w-full sm:w-auto px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
          >
            {{ 'common.cancel' | translate }}
          </button>
          <button
            type="submit"
            [disabled]="!statusForm.name"
            class="w-full sm:w-auto px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {{ 'common.save' | translate }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>


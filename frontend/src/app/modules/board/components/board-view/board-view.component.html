<div class="max-w-7xl mx-auto px-1 sm:px-2 md:px-4">
  <div class="mb-3 sm:mb-4 md:mb-6">
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-4 mb-2 sm:mb-4">
    <button
      (click)="goBack()"
        class="text-xs sm:text-sm md:text-base text-indigo-600 hover:text-indigo-800"
      >
        ‚Üê {{ 'boards.backToBoards' | translate }}
      </button>
      
      <!-- Filter Options -->
      <div class="flex items-center gap-2 flex-wrap">
        <!-- Filter by Client -->
        <div class="relative filter-client-dropdown" *ngIf="clients.length > 0">
          <button
            type="button"
            (click)="openFilterClientDropdown(); $event.stopPropagation()"
            class="inline-flex items-center px-3 py-1.5 text-xs sm:text-sm border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          >
            <svg class="w-4 h-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
            </svg>
            {{ 'tasks.client' | translate }}
            <svg class="w-4 h-4 ml-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div
            *ngIf="showFilterClientDropdown"
            class="filter-client-dropdown absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg z-50 border border-gray-200 max-h-60 overflow-y-auto"
            (click)="$event.stopPropagation()"
          >
            <div class="p-2">
              <input
                type="text"
                [(ngModel)]="filterClientSearchTerm"
                (ngModelChange)="updateFilteredClients()"
                [ngModelOptions]="{standalone: true}"
                [placeholder]="translationService.translate('common.search') + ' ' + translationService.translate('tasks.client')"
                class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-indigo-500 mb-2"
              />
              <div class="space-y-1">
                <label
                  *ngFor="let client of filteredClients"
                  class="flex items-center px-2 py-1 hover:bg-gray-50 cursor-pointer"
                >
                  <input
                    type="checkbox"
                    [checked]="isFilterClientSelected(client._id)"
                    (change)="toggleFilterClient(client._id)"
                    class="mr-2"
                  />
                  <span class="text-xs text-gray-700">{{ client.name }}{{ client.type === 'persona' && client.lastName ? ' ' + client.lastName : '' }}</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Filter by Assignee -->
        <div class="relative filter-assignee-dropdown" *ngIf="users.length > 0">
          <button
            type="button"
            (click)="openFilterAssigneeDropdown(); $event.stopPropagation()"
            class="inline-flex items-center px-3 py-1.5 text-xs sm:text-sm border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          >
            <svg class="w-4 h-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
            {{ 'tasks.assignedTo' | translate }}
            <svg class="w-4 h-4 ml-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div
            *ngIf="showFilterAssigneeDropdown"
            class="filter-assignee-dropdown absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg z-50 border border-gray-200 max-h-60 overflow-y-auto"
            (click)="$event.stopPropagation()"
          >
            <div class="p-2">
              <input
                type="text"
                [(ngModel)]="filterAssigneeSearchTerm"
                (ngModelChange)="updateFilteredUsers()"
                [ngModelOptions]="{standalone: true}"
                [placeholder]="translationService.translate('common.search') + ' ' + translationService.translate('tasks.assignedTo')"
                class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-indigo-500 mb-2"
              />
              <div class="space-y-1">
                <label
                  *ngFor="let user of filteredUsers"
                  class="flex items-center px-2 py-1 hover:bg-gray-50 cursor-pointer"
                >
                  <input
                    type="checkbox"
                    [checked]="isFilterAssigneeSelected(user._id)"
                    (change)="toggleFilterAssignee(user._id)"
                    class="mr-2"
                  />
                  <span class="text-xs text-gray-700">{{ user.firstName }} {{ user.lastName }}</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Filter by Status -->
        <div class="relative filter-status-dropdown" *ngIf="columns.length > 0">
          <button
            type="button"
            (click)="openFilterStatusDropdown(); $event.stopPropagation()"
            class="inline-flex items-center px-3 py-1.5 text-xs sm:text-sm border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          >
            <svg class="w-4 h-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            {{ 'admin.statusName' | translate }}
            <svg class="w-4 h-4 ml-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div
            *ngIf="showFilterStatusDropdown"
            class="filter-status-dropdown absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg z-50 border border-gray-200 max-h-60 overflow-y-auto"
            (click)="$event.stopPropagation()"
          >
            <div class="p-2">
              <div class="space-y-1">
                <label
                  *ngFor="let column of columns"
                  class="flex items-center px-2 py-1 hover:bg-gray-50 cursor-pointer"
                >
                  <input
                    type="checkbox"
                    [checked]="isFilterStatusSelected(column._id || column.name)"
                    (change)="toggleFilterStatus(column._id || column.name)"
                    class="mr-2"
                  />
                  <div class="flex items-center space-x-2">
                    <div
                      *ngIf="column.color"
                      class="w-3 h-3 rounded-full"
                      [style.background-color]="column.color"
                    ></div>
                    <span class="text-xs text-gray-700">{{ column.name }}</span>
                  </div>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Filter by Priority -->
        <div class="relative filter-priority-dropdown">
          <button
            type="button"
            (click)="openFilterPriorityDropdown(); $event.stopPropagation()"
            class="inline-flex items-center px-3 py-1.5 text-xs sm:text-sm border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          >
            <svg class="w-4 h-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            {{ 'tasks.priority' | translate }}
            <svg class="w-4 h-4 ml-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div
            *ngIf="showFilterPriorityDropdown"
            class="filter-priority-dropdown absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-50 border border-gray-200"
            (click)="$event.stopPropagation()"
          >
            <div class="p-2">
              <div class="space-y-1">
                <label
                  *ngFor="let priority of filteredPriorities"
                  class="flex items-center px-2 py-1 hover:bg-gray-50 cursor-pointer"
                >
                  <input
                    type="checkbox"
                    [checked]="isFilterPrioritySelected(priority.value)"
                    (change)="toggleFilterPriority(priority.value)"
                    class="mr-2"
                  />
                  <span class="text-xs text-gray-700">{{ priority.label }}</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Clear Filters Button -->
        <button
          *ngIf="hasActiveFilters()"
          type="button"
          (click)="clearFilters()"
          class="inline-flex items-center px-3 py-1.5 text-xs sm:text-sm border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500"
        >
          <svg class="w-4 h-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
          {{ 'common.clear' | translate }}
    </button>
      </div>
    </div>
    <h2 class="text-base sm:text-lg md:text-xl lg:text-2xl font-bold text-gray-900">{{ board?.name }}</h2>
    <p class="text-xs sm:text-sm md:text-base text-gray-600 mt-1 sm:mt-2">{{ board?.description }}</p>
  </div>

  <div *ngIf="loading" class="text-center py-12">
    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
  </div>

  <div *ngIf="!loading && !board" class="text-center py-12">
    <p class="text-gray-500">{{ 'boards.couldNotLoadBoard' | translate }}</p>
  </div>

  <div *ngIf="!loading && board && columns.length === 0" class="text-center py-12">
    <p class="text-gray-500">{{ 'boards.noColumnsInBoard' | translate }}</p>
  </div>

  <div *ngIf="!loading && board && columns.length > 0" class="flex gap-2 sm:gap-3 md:gap-4 overflow-x-auto pb-4 -mx-1 sm:-mx-2 md:mx-0 px-1 sm:px-2 md:px-0" cdkDropListGroup>
    <div
      *ngFor="let column of columns; let i = index"
      cdkDropList
      [id]="'column-' + i"
      [cdkDropListData]="column.tasks"
      (cdkDropListDropped)="drop($event, i)"
      class="flex-shrink-0 w-[280px] sm:w-72 md:w-80 rounded-lg p-2 sm:p-3 md:p-4"
      [style.background-color]="column.color ? (column.color + '15') : '#F3F4F6'"
    >
      <div class="flex items-center justify-between mb-3 sm:mb-4">
        <div class="flex items-center space-x-2">
          <div
            *ngIf="column.color"
            class="w-3 h-3 rounded-full flex-shrink-0"
            [style.background-color]="column.color"
          ></div>
          <h3 class="text-sm sm:text-base font-semibold text-gray-900">{{ column.name }}</h3>
        </div>
        <span class="text-xs sm:text-sm text-gray-500">{{ column.tasks.length }}</span>
      </div>

      <div class="space-y-2 sm:space-y-3 min-h-[150px] sm:min-h-[200px]">
        <div
          *ngFor="let task of column.tasks"
          cdkDrag
          (cdkDragStarted)="onDragStarted()"
          (cdkDragEnded)="onDragEnded()"
          (click)="!isDragging && openTaskModal(task)"
          class="bg-white rounded-lg shadow p-2.5 sm:p-3 md:p-4 cursor-grab active:cursor-grabbing hover:shadow-md transition-shadow"
        >
          <div class="flex items-start justify-between mb-2">
            <h4 class="text-sm sm:text-base font-medium text-gray-900 flex-1 pr-2">{{ task.title }}</h4>
            <span
              [class]="getPriorityClass(task.priority)"
              class="px-1.5 sm:px-2 py-0.5 sm:py-1 rounded text-xs font-medium flex-shrink-0"
            >
              {{ task.priority }}
            </span>
          </div>
          <!-- Cliente o Agente -->
          <div *ngIf="task.clientId" class="mb-2">
            <div class="flex items-center gap-1.5">
              <svg class="w-3 h-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
              <!-- Si es empresa, mostrar solo el agente -->
              <span *ngIf="getTaskClientType(task) === 'empresa' && getTaskAgentName(task)" class="text-xs text-gray-600 font-medium">
                {{ getTaskAgentName(task) }}
              </span>
              <!-- Si es persona, mostrar el cliente -->
              <span *ngIf="getTaskClientType(task) === 'persona' && getTaskClientName(task)" class="text-xs text-gray-600 font-medium">
                {{ getTaskClientName(task) }}
              </span>
            </div>
          </div>
          <!-- Etiquetas -->
          <div *ngIf="task.labels && task.labels.length > 0" class="flex flex-wrap gap-1 mb-2">
            <span
              *ngFor="let label of task.labels"
              class="px-2 py-0.5 rounded text-xs font-medium"
              [style.background-color]="label.color + '20'"
              [style.color]="label.color"
              [style.border-color]="label.color"
              style="border: 1px solid;"
            >
              {{ label.name }}
            </span>
          </div>
          <div *ngIf="task.description" class="text-xs sm:text-sm text-gray-600 mb-2 line-clamp-2 prose prose-sm max-w-none" [innerHTML]="task.description"></div>
          <div class="flex items-center justify-between mt-2">
            <div class="flex -space-x-1.5 sm:-space-x-2">
              <div
                *ngFor="let assignee of task.assignees"
                class="h-5 w-5 sm:h-6 sm:w-6 rounded-full bg-indigo-600 text-white text-xs flex items-center justify-center"
                [title]="assignee.firstName + ' ' + assignee.lastName"
              >
                {{ assignee.firstName[0] }}{{ assignee.lastName[0] }}
              </div>
            </div>
            <span *ngIf="task.dueDate" class="text-xs text-gray-500">
              {{ task.dueDate | date: 'short' }}
            </span>
          </div>
        </div>
      </div>

      <button
        (click)="openCreateTaskModal(i)"
        class="mt-3 sm:mt-4 w-full py-1.5 sm:py-2 text-xs sm:text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-200 rounded-lg transition-colors"
      >
        + {{ 'tasks.addTask' | translate }}
      </button>
    </div>
  </div>

  <!-- Task Modal -->
  <app-task-modal
    *ngIf="showTaskModal"
    [task]="selectedTask"
    [columns]="columns"
    [users]="users"
    [clients]="clients"
    [isOpen]="showTaskModal"
    (close)="closeTaskModal()"
    (save)="onTaskModalSave($event)"
    (delete)="onTaskModalDelete($event)"
    (taskUpdated)="onTaskUpdated($event)"
  ></app-task-modal>
</div>

